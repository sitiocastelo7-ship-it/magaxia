<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Cadastro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  background:#0f172a;
  color:#fff;
  font-family:Arial,Helvetica,sans-serif;
}
.container{
  max-width:420px;
  margin:auto;
  padding:40px 20px;
  text-align:center;
}
input,button{
  width:100%;
  padding:14px;
  margin-top:12px;
  border-radius:12px;
  border:none;
}
button{
  background:#22c55e;
  font-weight:bold;
  cursor:pointer;
}
input[readonly]{opacity:.7}
</style>
</head>

<body>
<div class="container">
  <h1>üìù Criar Conta</h1>

  <input id="nome" placeholder="Nome completo">
  <input id="telefone" placeholder="Telefone">
  <input id="senha" type="password" placeholder="Senha">
  <input id="confirmSenha" type="password" placeholder="Confirmar senha">
  <input id="codigoConvite" placeholder="C√≥digo de convite">

  <button onclick="cadastrar()">Cadastrar</button>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyAcVPgUHbL4N9U1-H68klmGKWQF-YGleyc",
  authDomain:"vastbitloud-2872a.firebaseapp.com",
  projectId:"vastbitloud-2872a"
});

const auth = firebase.auth();
const db = firebase.firestore();

// üëâ CAPTURAR ?ref DO LINK
const params = new URLSearchParams(window.location.search);
const refLink = params.get("ref");

// üëâ AUTO-PREENCHER SE VEIO PELO LINK
if(refLink){
  const c = document.getElementById("codigoConvite");
  c.value = refLink;
  c.readOnly = true;
}

async function cadastrar(){
  const nome = nome.value.trim();
  const telefone = document.getElementById("telefone").value.trim();
  const senha = document.getElementById("senha").value;
  const confirmSenha = document.getElementById("confirmSenha").value;
  const codigoConvite = document.getElementById("codigoConvite").value.trim();

  if(!nome || !telefone || !senha){
    alert("Preencha todos os campos");
    return;
  }
  if(senha !== confirmSenha){
    alert("Senhas diferentes");
    return;
  }

  const refFinal = codigoConvite || null;

  const email = `user${Date.now()}@mail.com`;
  const cred = await auth.createUserWithEmailAndPassword(email, senha);
  const user = cred.user;

  await db.collection("users").doc(user.uid).set({
    uid: user.uid,
    nome: nome,
    telefone: telefone,
    codigoConvite: user.uid,
    ref: refFinal,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  alert("Cadastro realizado!");
  location.href="login.html";
}
</script>
</body>
</html>
