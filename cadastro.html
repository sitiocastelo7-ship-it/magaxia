<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Cadastro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
    background:#0f172a;
    color:#fff;
    font-family:Arial,Helvetica,sans-serif;
    text-align:center;
}
.container{
    max-width:420px;
    margin:auto;
    padding:40px 20px;
}
input,button{
    width:100%;
    padding:14px;
    margin-top:12px;
    border-radius:12px;
    border:none;
    font-size:0.95rem;
}
button{
    background:#22c55e;
    font-weight:bold;
    cursor:pointer;
}
input[readonly]{
    opacity:.7;
}
</style>
</head>

<body>
<div class="container">
    <h1>Criar Conta</h1>

    <input type="text" id="nome" placeholder="Nome completo">
    <input type="tel" id="telefone" placeholder="Telefone (ex: +5511999999999)">
    <input type="password" id="senha" placeholder="Senha">
    <input type="password" id="confirmSenha" placeholder="Confirmar senha">
    <input type="text" id="codigoConvite" placeholder="CÃ³digo de convite (opcional)">

    <button onclick="cadastrar()">Cadastrar</button>

    <p style="margin-top:8px;font-size:.95rem;color:#cbd5e1">
        JÃ¡ tem conta? <a href="login.html" style="color:#60a5fa">Entrar</a>
    </p>
</div>

<script>
// ðŸ”¥ FIREBASE CONFIG
const firebaseConfig={
  apiKey:"AIzaSyAcVPgUHbL4N9U1-H68klmGKWQF-YGleyc",
  authDomain:"vastbitloud-2872a.firebaseapp.com",
  projectId:"vastbitloud-2872a"
};

firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

// ==================================================
// ðŸ”— AUTOMÃTICO: CAPTURAR ?ref DO LINK DE CONVITE
// ==================================================
const params = new URLSearchParams(window.location.search);
const ref = params.get("ref");

// ðŸ”— SE VEIO PELO LINK, PREENCHE O CÃ“DIGO AUTOMATICAMENTE
if(ref){
    const campoConvite = document.getElementById("codigoConvite");
    campoConvite.value = ref;      // preenche sozinho
    campoConvite.readOnly = true;  // trava para nÃ£o alterar
}

// ==================================================
// ðŸ§¾ CADASTRO (ORIGINAL)
// ==================================================
async function cadastrar(){
    const nome=document.getElementById("nome").value.trim();
    const telefone=document.getElementById("telefone").value.trim();
    const senha=document.getElementById("senha").value;
    const confirmSenha=document.getElementById("confirmSenha").value;
    const codigoConvite=document.getElementById("codigoConvite").value.trim();

    if(!nome || !telefone || !senha){
        alert("Preencha nome, telefone e senha.");
        return;
    }
    if(senha!==confirmSenha){
        alert("As senhas nÃ£o coincidem.");
        return;
    }

    // prioridade: campo > link
    const refToUse = codigoConvite || ref || null;

    // verificar telefone duplicado
    const existing=await db.collection("users").where("telefone","==",telefone).get();
    if(!existing.empty){
        alert("Telefone jÃ¡ cadastrado.");
        return;
    }

    // email sintÃ©tico
    const telNorm=telefone.replace(/\D/g,"");
    const email=`user${telNorm || Date.now()}@noemail.local`;

    try{
        const cred=await auth.createUserWithEmailAndPassword(email,senha);
        const user=cred.user;

        // salvar nome no Auth
        await user.updateProfile({ displayName:nome });

        // salvar no Firestore
        await db.collection("users").doc(user.uid).set({
            uid:user.uid,
            nome:nome,
            telefone:telefone,
            authEmail:email,
            codigoConvite:user.uid,
            ref:refToUse,
            nivel1:0,
            nivel2:0,
            nivel3:0,
            createdAt:firebase.firestore.FieldValue.serverTimestamp()
        });

        // ðŸ”— PROCESSAR INDICAÃ‡ÃƒO (ORIGINAL)
        if(refToUse){
            const refDoc=await db.collection("users").doc(refToUse).get();
            if(refDoc.exists){
                await db.collection("users").doc(refToUse).update({
                    nivel1:firebase.firestore.FieldValue.increment(1)
                });

                const ref2=refDoc.data().ref;
                if(ref2){
                    await db.collection("users").doc(ref2).update({
                        nivel2:firebase.firestore.FieldValue.increment(1)
                    });

                    const ref2Doc=await db.collection("users").doc(ref2).get();
                    const ref3=ref2Doc.data().ref;
                    if(ref3){
                        await db.collection("users").doc(ref3).update({
                            nivel3:firebase.firestore.FieldValue.increment(1)
                        });
                    }
                }
            }
        }

        alert("Cadastro realizado com sucesso!");
        window.location.href="login.html";

    }catch(err){
        console.error(err);
        alert("Erro no cadastro: "+err.message);
    }
}
</script>
</body>
</html>
