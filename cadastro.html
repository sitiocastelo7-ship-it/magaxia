<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Cadastro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body {
    background:#0f172a;
    color:#fff;
    font-family:Arial;
    text-align:center;
}
.container {
    max-width:420px;
    margin:auto;
    padding:40px 20px;
}
input, button {
    width:100%;
    padding:14px;
    margin-top:12px;
    border-radius:12px;
    border:none;
}
button {
    background:#22c55e;
    font-weight:bold;
    cursor:pointer;
}
</style>
</head>

<body>
<div class="container">
    <h1>Criar Conta</h1>

    <input type="tel" id="telefone" placeholder="Telefone (ex: +5511999999999)">
    <input type="password" id="senha" placeholder="Senha">
    <input type="password" id="confirmSenha" placeholder="Confirmar senha">
    <input type="text" id="codigoConvite" placeholder="C√≥digo de convite (opcional)">

    <button onclick="cadastrar()">Cadastrar</button>
    <p style="margin-top:8px; font-size:0.95rem; color:#cbd5e1">J√° tem conta? <a href="login.html" style="color:#60a5fa">Entrar</a></p>
</div>

<script>
// üî• FIREBASE CONFIG (SUA)
const firebaseConfig = {
  apiKey: "AIzaSyAcVPgUHbL4N9U1-H68klmGKWQF-YGleyc",
  authDomain: "vastbitloud-2872a.firebaseapp.com",
  projectId: "vastbitloud-2872a",
  storageBucket: "vastbitloud-2872a.firebasestorage.app",
  messagingSenderId: "952931184412",
  appId: "1:952931184412:web:ee2a0e38826c30dd0cd4d9",
  measurementId: "G-KWVQ0CFHW2"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// üîó PEGAR REF
const params = new URLSearchParams(window.location.search);
const ref = params.get("ref");

// üîê CADASTRO
async function cadastrar() {
    const telefone = document.getElementById("telefone").value.trim();
    const senha = document.getElementById("senha").value;
    const confirmSenha = document.getElementById("confirmSenha").value;
    const codigoConvite = document.getElementById("codigoConvite").value.trim();

    if(!telefone || !senha){
        alert('Preencha telefone e senha.');
        return;
    }
    if(senha !== confirmSenha){
        alert('As senhas n√£o coincidem.');
        return;
    }

    // decide refer√™ncia: campo de c√≥digo tem prioridade sobre ?ref na URL
    const refToUse = codigoConvite || ref || null;

    // n√£o salvar senha em localStorage nem redirecionar aqui;
    // prosseguir para criar o usu√°rio imediatamente

    // Verificar se telefone j√° est√° cadastrado no Firestore
    try{
        const existing = await db.collection('users').where('telefone','==',telefone).get();
        if(!existing.empty){
            alert('Telefone j√° cadastrado. Fa√ßa login ou recupere sua conta.');
            return;
        }
    } catch(e){
        console.warn('Erro ao verificar telefone existente', e);
        // continuar mesmo se a verifica√ß√£o falhar
    }

    // Gerar email sint√©tico (Firebase exige email para createUserWithEmailAndPassword)
    let syntheticEmail = null;
    const telNorm = telefone.replace(/\D/g, '');
    if(telNorm) {
        syntheticEmail = `user${telNorm}@noemail.local`;
    } else if(codigoConvite) {
        syntheticEmail = `${codigoConvite}@noemail.local`;
    } else {
        syntheticEmail = `user${Date.now()}@noemail.local`;
    }
    try {
        const cred = await auth.createUserWithEmailAndPassword(syntheticEmail, senha);
        const uid = cred.user.uid;

        // criar usu√°rio com telefone e c√≥digo de convite (armazenamos email como null j√° que n√£o coletamos)
        await db.collection("users").doc(uid).set({
            uid: uid,
            authEmail: syntheticEmail,
            telefone: telefone || null,
            codigoConvite: uid,
            ref: refToUse,
            nivel1: 0,
            nivel2: 0,
            nivel3: 0
        });

        // processar indica√ß√£o
        if (refToUse) {
            const refDoc = await db.collection("users").doc(refToUse).get();
            if (refDoc.exists) {
                await db.collection("users").doc(refToUse).update({
                    nivel1: firebase.firestore.FieldValue.increment(1)
                });

                const ref2 = refDoc.data().ref;
                if (ref2) {
                    await db.collection("users").doc(ref2).update({
                        nivel2: firebase.firestore.FieldValue.increment(1)
                    });

                    const ref2Doc = await db.collection("users").doc(ref2).get();
                    const ref3 = ref2Doc.data().ref;
                    if (ref3) {
                        await db.collection("users").doc(ref3).update({
                            nivel3: firebase.firestore.FieldValue.increment(1)
                        });
                    }
                }
            }
        }

        alert("Cadastro realizado com sucesso!");
        window.location.href = "login.html";
    } catch (err) {
        // Se email sint√©tico j√° existe, tentar alternativas curtas antes de falhar
        if(err && err.code === 'auth/email-already-in-use'){
            let created = false;
            let lastErr = err;
            for(let i=0;i<3;i++){
                const altEmail = telNorm ? `user${telNorm}_${Math.floor(Math.random()*900000)}@noemail.local` : `user${Date.now()}_${i}@noemail.local`;
                try{
                    const cred2 = await auth.createUserWithEmailAndPassword(altEmail, senha);
                        const uid2 = cred2.user.uid;
                        await db.collection("users").doc(uid2).set({
                            uid: uid2,
                            authEmail: altEmail,
                            telefone: telefone || null,
                            codigoConvite: uid2,
                            ref: refToUse,
                            nivel1: 0,
                            nivel2: 0,
                            nivel3: 0
                        });

                    // processar indica√ß√£o (mesma l√≥gica)
                    if (refToUse) {
                        const refDoc = await db.collection("users").doc(refToUse).get();
                        if (refDoc.exists) {
                            await db.collection("users").doc(refToUse).update({
                                nivel1: firebase.firestore.FieldValue.increment(1)
                            });
                            const ref2 = refDoc.data().ref;
                            if (ref2) {
                                await db.collection("users").doc(ref2).update({
                                    nivel2: firebase.firestore.FieldValue.increment(1)
                                });
                                const ref2Doc = await db.collection("users").doc(ref2).get();
                                const ref3 = ref2Doc.data().ref;
                                if (ref3) {
                                    await db.collection("users").doc(ref3).update({
                                        nivel3: firebase.firestore.FieldValue.increment(1)
                                    });
                                }
                            }
                        }
                    }

                    alert("Cadastro realizado com sucesso!");
                    window.location.href = "login.html";
                    created = true;
                    break;
                } catch(e2){
                    lastErr = e2;
                }
            }
            if(!created){
                console.error('Erro no cadastro', lastErr);
                alert('Erro no cadastro: ' + (lastErr.message || lastErr));
            }
        } else {
            console.error('Erro no cadastro', err);
            alert('Erro no cadastro: ' + (err.message || err));
        }
    }
}
</script>
</body>
</html>
