<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Cadastro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
    background:#0f172a;
    color:#fff;
    font-family:Arial,Helvetica,sans-serif;
    text-align:center;
}
.container{
    max-width:420px;
    margin:auto;
    padding:40px 20px;
}
input,button{
    width:100%;
    padding:14px;
    margin-top:12px;
    border-radius:12px;
    border:none;
    font-size:0.95rem;
}
button{
    background:#22c55e;
    font-weight:bold;
    cursor:pointer;
}
input[readonly]{
    opacity:.7;
}
.msg{
    margin-top:10px;
    font-size:.9rem;
    color:#38bdf8;
}
</style>
</head>

<body>
<div style="position:fixed; top:10px; right:10px; z-index:9999; padding:10px 15px; border-radius:8px; font-weight:bold; font-size:12px;" id="status-badge">...</div>

<div class="container">
    <h1>Criar Conta</h1>

    <input type="text" id="nome" placeholder="Nome completo">
    <input type="tel" id="telefone" placeholder="Telefone (ex: +5511999999999)">
    <input type="password" id="senha" placeholder="Senha">
    <input type="password" id="confirmSenha" placeholder="Confirmar senha">
    <input type="text" id="codigoConvite" placeholder="CÃ³digo de convite (opcional)">

    <div id="msgConvite" class="msg"></div>

    <button onclick="cadastrar()">Cadastrar</button>

    <p style="margin-top:10px;color:#cbd5e1">
        JÃ¡ tem conta? <a href="login.html" style="color:#60a5fa">Entrar</a>
    </p>
</div>

<script>
// ===============================
// ðŸ”¥ FIREBASE CONFIG
// ===============================
const firebaseConfig={
  apiKey:"AIzaSyAcVPgUHbL4N9U1-H68klmGKWQF-YGleyc",
  authDomain:"vastbitloud-2872a.firebaseapp.com",
  projectId:"vastbitloud-2872a"
};

firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

// ===============================
// ðŸ”’ VARIÃVEIS GLOBAIS
// ===============================
let ref = null;
let origemConvite = null;

// ===============================
// ðŸ” VALIDAR CONVITE NO FIRESTORE
// ===============================
async function validarConvite(uid){
    if(!uid) return null;
    try{
        const doc = await db.collection("users").doc(uid).get();
        return doc.exists ? uid : null;
    }catch(e){
        console.error("Erro ao validar convite:", e);
        return null;
    }
}

// ===============================
// ðŸ”— AUTO PREENCHIMENTO VIA LINK
// ===============================
async function preencherConvite(){
    const badge = document.getElementById("status-badge");
    
    console.log("ðŸ”„ [preencherConvite] Iniciado");
    if(badge) badge.textContent = "ðŸ”„ Processando...";
    if(badge) badge.style.background = "#1e40af";
    if(badge) badge.style.color = "#fff";
    
    const url = new URL(window.location.href);
    const refParam = url.searchParams.get("ref");
    const inviteParam = url.searchParams.get("invite");
    const paramValue = refParam || inviteParam;
    const paramKey = refParam ? "ref" : (inviteParam ? "invite" : null);

    console.log("ðŸ”„ [preencherConvite] paramValue:", paramValue);

    if(paramValue){
        const campo = document.getElementById("codigoConvite");
        const msgDiv = document.getElementById("msgConvite");
        
        // Preenche o campo IMEDIATAMENTE
        if(campo){
            campo.value = paramValue;
            campo.readOnly = true;
            console.log("âœ… [preencherConvite] Campo preenchido com:", paramValue);
            if(badge) badge.textContent = "âœ… Preenchido!";
            if(badge) badge.style.background = "#22c55e";
        } else {
            console.error("âŒ [preencherConvite] Campo #codigoConvite NÃƒO ENCONTRADO!");
            if(badge) badge.textContent = "âŒ Erro: Campo nÃ£o encontrado";
            if(badge) badge.style.background = "#ef4444";
        }

        // Mostra mensagem de validaÃ§Ã£o
        if(msgDiv){
            msgDiv.innerText = "ðŸ”Ž Validando cÃ³digo de convite...";
        }

        // Aguarda validaÃ§Ã£o
        try{
            console.log("ðŸ”„ [preencherConvite] Chamando validarConvite()");
            const valido = await validarConvite(paramValue);
            console.log("ðŸ”„ [preencherConvite] Resultado:", valido);
            
            if(valido){
                ref = valido;
                if(msgDiv){
                    msgDiv.innerText = "ðŸŽ‰ VocÃª foi convidado por um parceiro Magaxia";
                }

                origemConvite = {
                    ref: ref,
                    url: window.location.href,
                    userAgent: navigator.userAgent,
                    data: new Date().toISOString()
                };
                console.log("âœ… [preencherConvite] Convite vÃ¡lido:", valido);
                if(badge) badge.textContent = "âœ… Validado!";
            }else{
                console.warn("âš ï¸ [preencherConvite] Convite invÃ¡lido:", paramValue);
                alert("âš ï¸ CÃ³digo de convite invÃ¡lido.");
                if(paramKey) url.searchParams.delete(paramKey);
                window.history.replaceState({}, "", url);
                if(campo){ campo.value = ""; campo.readOnly = false; }
                if(msgDiv) msgDiv.innerText = "";
                if(badge) badge.textContent = "âš ï¸ InvÃ¡lido";
                if(badge) badge.style.background = "#f59e0b";
            }
        }catch(e){
            console.error("âŒ [preencherConvite] Erro:", e);
            if(msgDiv){
                msgDiv.innerText = "âš ï¸ NÃ£o foi possÃ­vel validar o convite agora.";
            }
            if(badge) badge.textContent = "âš ï¸ Erro na validaÃ§Ã£o";
            if(badge) badge.style.background = "#f59e0b";
        }
    } else {
        console.log("ðŸ“ [preencherConvite] Nenhum parÃ¢metro ?ref= ou ?invite=");
        if(badge) badge.textContent = "ðŸ“Œ Sem parÃ¢metro";
        if(badge) badge.style.background = "#6b7280";
    }
}

// ===============================
// ðŸš€ EXECUTAR PREENCHIMENTO IMEDIATAMENTE
// ===============================
// Executa com delay para garantir que DOM estÃ¡ pronto
setTimeout(() => {
    console.log("ðŸš€ Chamando preencherConvite()");
    preencherConvite();
}, 100);

// ===============================
// ðŸ§¾ CADASTRO
// ===============================
async function cadastrar(){
    const nome = document.getElementById("nome").value.trim();
    const telefone = document.getElementById("telefone").value.trim();
    const senha = document.getElementById("senha").value;
    const confirmSenha = document.getElementById("confirmSenha").value;
    const codigoDigitado = document.getElementById("codigoConvite").value.trim();

    if(!nome || !telefone || !senha){
        alert("Preencha todos os campos obrigatÃ³rios.");
        return;
    }
    if(senha !== confirmSenha){
        alert("As senhas nÃ£o coincidem.");
        return;
    }

    // prioridade: campo > link
    const refToUse = codigoDigitado || ref || null;

    // verificar telefone duplicado
    const existing = await db.collection("users")
        .where("telefone","==",telefone).get();

    if(!existing.empty){
        alert("Telefone jÃ¡ cadastrado.");
        return;
    }

    // email sintÃ©tico
    const telNorm = telefone.replace(/\D/g,"");
    const email = `user${telNorm || Date.now()}@noemail.local`;

    try{
        const cred = await auth.createUserWithEmailAndPassword(email,senha);
        const user = cred.user;

        await user.updateProfile({ displayName:nome });

        await db.collection("users").doc(user.uid).set({
            uid: user.uid,
            nome: nome,
            telefone: telefone,
            authEmail: email,
            codigoConvite: user.uid,
            ref: refToUse,
            origemConvite: origemConvite,
            nivel1: 0,
            nivel2: 0,
            nivel3: 0,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // ===============================
        // ðŸ“ˆ PROCESSAR INDICAÃ‡ÃƒO
        // ===============================
        if(refToUse){
            const refDoc = await db.collection("users").doc(refToUse).get();
            if(refDoc.exists){
                await db.collection("users").doc(refToUse).update({
                    nivel1: firebase.firestore.FieldValue.increment(1)
                });

                const ref2 = refDoc.data().ref;
                if(ref2){
                    await db.collection("users").doc(ref2).update({
                        nivel2: firebase.firestore.FieldValue.increment(1)
                    });

                    const ref2Doc = await db.collection("users").doc(ref2).get();
                    const ref3 = ref2Doc.data().ref;
                    if(ref3){
                        await db.collection("users").doc(ref3).update({
                            nivel3: firebase.firestore.FieldValue.increment(1)
                        });
                    }
                }
            }
        }

        alert("âœ… Cadastro realizado com sucesso!");
        window.location.href="login.html";

    }catch(err){
        console.error(err);
        alert("Erro no cadastro: "+err.message);
    }
}
</script>
</body>
</html>
